apiVersion: v1
kind: Service
metadata:
  name: mongodb
  namespace: trm
  labels:
    app.kubernetes.io/name: mongodb
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: trm-platform
    app.kubernetes.io/instance: mongodb
spec:
  type: ClusterIP
  clusterIP: None
  selector:
    app.kubernetes.io/name: mongodb
    app.kubernetes.io/component: database
  ports:
    - name: mongodb
      port: 27017
      targetPort: 27017
      protocol: TCP
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mongodb-init-scripts
  namespace: trm
  labels:
    app.kubernetes.io/name: mongodb
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: trm-platform
data:
  init-replica-set.js: |
    rs.initiate({
      _id: "trm-rs",
      members: [
        { _id: 0, host: "mongodb-0.mongodb:27017", priority: 2 },
        { _id: 1, host: "mongodb-1.mongodb:27017", priority: 1 },
        { _id: 2, host: "mongodb-2.mongodb:27017", priority: 1, arbiterOnly: false }
      ]
    });
    
    // Wait for replica set to initialize
    sleep(5000);
    
    // Create application user
    db = db.getSiblingDB('admin');
    db.createUser({
      user: "trm_user",
      pwd: process.env.MONGODB_PASSWORD,
      roles: [
        { role: "readWrite", db: "trm_production" },
        { role: "dbAdmin", db: "trm_production" },
        { role: "read", db: "local" }
      ]
    });
    
    // Enable database profiling for slow queries
    db.setProfilingLevel(1, { slowms: 100 });
    
    print('Replica set initialized and user created successfully');
  
  health-check.sh: |
    #!/bin/bash
    mongosh --eval "db.adminCommand('ping')" --quiet && exit 0 || exit 1
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mongodb
  namespace: trm
  labels:
    app.kubernetes.io/name: mongodb
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: trm-platform
    app.kubernetes.io/instance: mongodb
    version: "6.0"
spec:
  serviceName: mongodb
  replicas: 3
  podManagementPolicy: OrderedReady
  updateStrategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app.kubernetes.io/name: mongodb
      app.kubernetes.io/component: database
  template:
    metadata:
      labels:
        app.kubernetes.io/name: mongodb
        app.kubernetes.io/component: database
        app.kubernetes.io/part-of: trm-platform
        app.kubernetes.io/instance: mongodb
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9216"
        prometheus.io/path: "/metrics"
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - mongodb
                topologyKey: kubernetes.io/hostname
            - weight: 50
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - mongodb
                topologyKey: topology.kubernetes.io/zone
      containers:
        - name: mongodb
          image: mongo:6.0-focal
          imagePullPolicy: IfNotPresent
          command:
            - mongod
            - --bind_ip_all
            - --replSet
            - trm-rs
            - --auth
            - --keyFile
            - /etc/mongodb-keyfile/keyfile
            - --dbpath
            - /data/db
            - --port
            - "27017"
            - --oplogSize
            - "1024"
            - --wiredTigerCacheSizeGB
            - "2"
          ports:
            - name: mongodb
              containerPort: 27017
              protocol: TCP
          env:
            - name: MONGO_INITDB_ROOT_USERNAME
              valueFrom:
                secretKeyRef:
                  name: trm-app-secrets
                  key: MONGODB_USERNAME
            - name: MONGO_INITDB_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: trm-app-secrets
                  key: MONGODB_PASSWORD
            - name: MONGODB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: trm-app-secrets
                  key: MONGODB_PASSWORD
          resources:
            requests:
              cpu: "500m"
              memory: "1Gi"
            limits:
              cpu: "2000m"
              memory: "4Gi"
          livenessProbe:
            exec:
              command:
                - mongosh
                - --eval
                - "db.adminCommand('ping')"
                - --quiet
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5
            successThreshold: 1
          readinessProbe:
            exec:
              command:
                - mongosh
                - --eval
                - "db.adminCommand('ping')"
                - --quiet
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
            successThreshold: 1
          startupProbe:
            exec:
              command:
                - mongosh
                - --eval
                - "db.adminCommand('ping')"
                - --quiet
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 30
          volumeMounts:
            - name: mongodb-data
              mountPath: /data/db
            - name: mongodb-keyfile
              mountPath: /etc/mongodb-keyfile
              readOnly: true
            - name: init-scripts
              mountPath: /docker-entrypoint-initdb.d
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            runAsNonRoot: true
            runAsUser: 999
            runAsGroup: 999
          lifecycle:
            preStop:
              exec:
                command:
                  - mongosh
                  - --eval
                  - "db.adminCommand({shutdown: 1, force: true, timeoutSecs: 10})"
        - name: mongodb-exporter
          image: percona/mongodb_exporter:0.39
          imagePullPolicy: IfNotPresent
          args:
            - --mongodb.uri=mongodb://$(MONGODB_USERNAME):$(MONGODB_PASSWORD)@localhost:27017/admin?authSource=admin
            - --compatible-mode
            - --collect-all
          env:
            - name: MONGODB_USERNAME
              valueFrom:
                secretKeyRef:
                  name: trm-app-secrets
                  key: MONGODB_USERNAME
            - name: MONGODB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: trm-app-secrets
                  key: MONGODB_PASSWORD
          ports:
            - name: metrics
              containerPort: 9216
              protocol: TCP
          resources:
            requests:
              cpu: "50m"
              memory: "128Mi"
            limits:
              cpu: "200m"
              memory: "256Mi"
          livenessProbe:
            httpGet:
              path: /
              port: 9216
            initialDelaySeconds: 30
            periodSeconds: 10
      volumes:
        - name: mongodb-keyfile
          secret:
            secretName: trm-app-secrets
            items:
              - key: DB_ENCRYPTION_KEY
                path: keyfile
            defaultMode: 0400
        - name: init-scripts
          configMap:
            name: mongodb-init-scripts
            defaultMode: 0755
      terminationGracePeriodSeconds: 120
  volumeClaimTemplates:
    - metadata:
        name: mongodb-data
        labels:
          app.kubernetes.io/name: mongodb
          app.kubernetes.io/component: storage
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: fast-ssd
        resources:
          requests:
            storage: 50Gi
---
# MongoDB Backup CronJob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: mongodb-backup
  namespace: trm
  labels:
    app.kubernetes.io/name: mongodb-backup
    app.kubernetes.io/component: backup
    app.kubernetes.io/part-of: trm-platform
spec:
  schedule: "0 2 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/name: mongodb-backup
            app.kubernetes.io/component: backup
        spec:
          restartPolicy: OnFailure
          containers:
            - name: mongodb-backup
              image: mongo:6.0-focal
              imagePullPolicy: IfNotPresent
              command:
                - /bin/sh
                - -c
                - |
                  TIMESTAMP=$(date +%Y%m%d_%H%M%S)
                  BACKUP_DIR=/backup/$TIMESTAMP
                  mkdir -p $BACKUP_DIR
                  
                  # Perform backup
                  mongodump \
                    --host mongodb-0.mongodb:27017,mongodb-1.mongodb:27017,mongodb-2.mongodb:27017 \
                    --username=$MONGODB_USERNAME \
                    --password=$MONGODB_PASSWORD \
                    --authenticationDatabase=admin \
                    --db=trm_production \
                    --out=$BACKUP_DIR \
                    --gzip
                  
                  # Encrypt backup
                  tar -czf - $BACKUP_DIR | gpg --symmetric --cipher-algo AES256 --passphrase "$BACKUP_ENCRYPTION_KEY" --batch -o /backup/trm_backup_$TIMESTAMP.tar.gz.gpg
                  
                  # Upload to S3
                  aws s3 cp /backup/trm_backup_$TIMESTAMP.tar.gz.gpg s3://trm-backups/mongodb/
                  
                  # Cleanup old backups (keep last 30 days)
                  find /backup -name "*.gpg" -mtime +30 -delete
                  
                  echo "Backup completed: trm_backup_$TIMESTAMP.tar.gz.gpg"
              env:
                - name: MONGODB_USERNAME
                  valueFrom:
                    secretKeyRef:
                      name: trm-app-secrets
                      key: MONGODB_USERNAME
                - name: MONGODB_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: trm-app-secrets
                      key: MONGODB_PASSWORD
                - name: BACKUP_ENCRYPTION_KEY
                  valueFrom:
                    secretKeyRef:
                      name: trm-backup-encryption
                      key: BACKUP_ENCRYPTION_KEY
                - name: AWS_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      name: trm-backup-encryption
                      key: BACKUP_S3_ACCESS_KEY
                - name: AWS_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: trm-backup-encryption
                      key: BACKUP_S3_SECRET_KEY
                - name: AWS_DEFAULT_REGION
                  value: "us-east-1"
              resources:
                requests:
                  cpu: "200m"
                  memory: "512Mi"
                limits:
                  cpu: "500m"
                  memory: "1Gi"
              volumeMounts:
                - name: backup-storage
                  mountPath: /backup
          volumes:
            - name: backup-storage
              emptyDir:
                sizeLimit: 10Gi
---
# PodDisruptionBudget for MongoDB
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: mongodb-pdb
  namespace: trm
  labels:
    app.kubernetes.io/name: mongodb
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: trm-platform
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: mongodb
      app.kubernetes.io/component: database