apiVersion: v1
kind: ConfigMap
metadata:
  name: trm-app-config
  namespace: trm
  labels:
    app.kubernetes.io/name: trm
    app.kubernetes.io/component: config
    app.kubernetes.io/part-of: trm-platform
data:
  # Application Configuration
  NODE_ENV: "production"
  PORT: "3000"
  API_URL: "https://api.trm.io"
  APP_NAME: "TRM Platform"
  APP_VERSION: "1.0.0"
  
  # Timezone and Locale
  TZ: "Asia/Rangoon"
  DEFAULT_LOCALE: "en"
  SUPPORTED_LOCALES: "en,my"
  
  # Logging Configuration
  LOG_LEVEL: "info"
  LOG_FORMAT: "json"
  ENABLE_REQUEST_LOGGING: "true"
  ENABLE_PERFORMANCE_MONITORING: "true"
  
  # Security Configuration
  CORS_ORIGIN: "https://trm.io,https://app.trm.io"
  RATE_LIMIT_WINDOW_MS: "900000"
  RATE_LIMIT_MAX_REQUESTS: "100"
  SESSION_TIMEOUT: "3600"
  PASSWORD_MIN_LENGTH: "8"
  MAX_LOGIN_ATTEMPTS: "5"
  LOCKOUT_DURATION_MINUTES: "30"
  
  # MongoDB Configuration
  MONGODB_DATABASE: "trm_production"
  MONGODB_AUTH_SOURCE: "admin"
  MONGODB_REPLICA_SET: "trm-rs"
  MONGODB_RETRY_WRITES: "true"
  MONGODB_WRITE_CONCERN: "majority"
  MONGODB_READ_PREFERENCE: "primaryPreferred"
  MONGODB_MAX_POOL_SIZE: "50"
  MONGODB_MIN_POOL_SIZE: "10"
  MONGODB_SERVER_SELECTION_TIMEOUT_MS: "30000"
  MONGODB_SOCKET_TIMEOUT_MS: "45000"
  MONGODB_HEARTBEAT_FREQUENCY_MS: "10000"
  
  # Redis Configuration
  REDIS_PORT: "6379"
  REDIS_DATABASE: "0"
  REDIS_KEY_PREFIX: "trm:"
  REDIS_CONNECT_TIMEOUT: "10000"
  REDIS_COMMAND_TIMEOUT: "5000"
  REDIS_RETRY_DELAY_ON_FAILOVER: "100"
  REDIS_ENABLE_READY_CHECK: "true"
  REDIS_MAX_RETRIES_PER_REQUEST: "3"
  REDIS_ENABLE_OFFLINE_QUEUE: "true"
  
  # Cache Configuration
  CACHE_TTL_SHORT: "300"
  CACHE_TTL_MEDIUM: "1800"
  CACHE_TTL_LONG: "86400"
  CACHE_TTL_SESSION: "3600"
  
  # Feature Flags
  FEATURE_REFERRAL_NETWORK: "true"
  FEATURE_KYC_VERIFICATION: "true"
  FEATURE_PAYOUT_AUTOMATION: "true"
  FEATURE_EMAIL_MARKETING: "true"
  FEATURE_ANALYTICS_ADVANCED: "true"
  FEATURE_WEBHOOKS: "true"
  FEATURE_API_ACCESS: "true"
  FEATURE_MOBILE_APP: "true"
  FEATURE_WHATSAPP_INTEGRATION: "true"
  FEATURE_ENTERPRISE_PLANS: "true"
  FEATURE_SUBSCRIPTION_MANAGEMENT: "true"
  FEATURE_COMPLIANCE_REPORTING: "true"
  FEATURE_WORKFLOW_AUTOMATION: "true"
  
  # Email Configuration
  EMAIL_FROM_NAME: "TRM Platform"
  EMAIL_FROM_ADDRESS: "noreply@trm.io"
  EMAIL_REPLY_TO: "support@trm.io"
  SMTP_PORT: "587"
  SMTP_SECURE: "true"
  
  # File Upload Configuration
  MAX_FILE_SIZE_MB: "10"
  ALLOWED_FILE_TYPES: "image/jpeg,image/png,image/gif,application/pdf"
  UPLOAD_PATH: "/app/uploads"
  
  # Pagination Defaults
  DEFAULT_PAGE_SIZE: "20"
  MAX_PAGE_SIZE: "100"
  
  # Job Processing
  JOB_PROCESSING_BATCH_SIZE: "100"
  PAYOUT_BATCH_SIZE: "50"
  NOTIFICATION_BATCH_SIZE: "500"
  
  # Webhook Configuration
  WEBHOOK_TIMEOUT_MS: "30000"
  WEBHOOK_RETRY_ATTEMPTS: "3"
  WEBHOOK_RETRY_DELAY_MS: "5000"
  
  # Currency Configuration
  DEFAULT_CURRENCY: "USD"
  SUPPORTED_CURRENCIES: "USD,MMK,EUR,SGD,THB"
  
  # Compliance Configuration
  KYC_REQUIRED_FOR_PAYOUT: "true"
  KYC_DOCUMENT_TYPES: "passport,national_id,driver_license"
  DATA_RETENTION_DAYS: "2555"
  GDPR_COMPLIANCE_MODE: "true"
  
  # Monitoring Configuration
  METRICS_ENABLED: "true"
  METRICS_PORT: "9090"
  HEALTH_CHECK_PATH: "/health"
  READINESS_CHECK_PATH: "/ready"
  
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: trm-redis-config
  namespace: trm
  labels:
    app.kubernetes.io/name: redis
    app.kubernetes.io/component: config
    app.kubernetes.io/part-of: trm-platform
data:
  redis.conf: |
    # Redis Configuration for TRM Platform
    
    # Network
    bind 0.0.0.0
    port 6379
    protected-mode yes
    
    # General
    daemonize no
    supervised no
    pidfile /var/run/redis/redis-server.pid
    loglevel notice
    logfile ""
    databases 16
    
    # Persistence
    save 900 1
    save 300 10
    save 60 10000
    stop-writes-on-bgsave-error yes
    rdbcompression yes
    rdbchecksum yes
    dbfilename dump.rdb
    dir /data
    
    # AOF Persistence
    appendonly yes
    appendfilename "appendonly.aof"
    appendfsync everysec
    no-appendfsync-on-rewrite no
    auto-aof-rewrite-percentage 100
    auto-aof-rewrite-min-size 64mb
    aof-load-truncated yes
    aof-use-rdb-preamble yes
    
    # Memory Management
    maxmemory 1gb
    maxmemory-policy allkeys-lru
    maxmemory-samples 5
    
    # Client Output Buffer Limits
    client-output-buffer-limit normal 0 0 0
    client-output-buffer-limit replica 256mb 64mb 60
    client-output-buffer-limit pubsub 32mb 8mb 60
    
    # Timeouts
    timeout 300
    tcp-keepalive 300
    
    # Slow Log
    slowlog-log-slower-than 10000
    slowlog-max-len 128
    
    # Event Notification
    notify-keyspace-events Ex
    
    # Hash Ziplist
    hash-max-ziplist-entries 512
    hash-max-ziplist-value 64
    list-max-ziplist-size -2
    list-compress-depth 0
    set-max-intset-entries 512
    zset-max-ziplist-entries 128
    zset-max-ziplist-value 64
    hll-sparse-max-bytes 3000
    stream-node-max-bytes 4096
    stream-node-max-entries 100
    
    # Security
    rename-command FLUSHDB ""
    rename-command FLUSHALL ""
    
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: trm-nginx-config
  namespace: trm
  labels:
    app.kubernetes.io/name: nginx
    app.kubernetes.io/component: config
    app.kubernetes.io/part-of: trm-platform
data:
  nginx.conf: |
    user nginx;
    worker_processes auto;
    error_log /var/log/nginx/error.log warn;
    pid /var/run/nginx.pid;
    
    events {
        worker_connections 4096;
        use epoll;
        multi_accept on;
    }
    
    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;
        
        # Logging Format
        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for" '
                        'rt=$request_time uct="$upstream_connect_time" '
                        'uht="$upstream_header_time" urt="$upstream_response_time"';
        
        access_log /var/log/nginx/access.log main;
        
        # Performance
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;
        server_tokens off;
        
        # Gzip Compression
        gzip on;
        gzip_vary on;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_types text/plain text/css text/xml application/json application/javascript 
                   application/rss+xml application/atom+xml image/svg+xml;
        
        # Rate Limiting Zones
        limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
        limit_req_zone $binary_remote_addr zone=auth:10m rate=5r/m;
        limit_conn_zone $binary_remote_addr zone=addr:10m;
        
        # Upstream Backend
        upstream trm_backend {
            least_conn;
            server trm-app:3000 max_fails=3 fail_timeout=30s;
            keepalive 32;
        }
        
        # Server Block
        server {
            listen 80;
            server_name _;
            
            # Security Headers
            add_header X-Frame-Options "SAMEORIGIN" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-XSS-Protection "1; mode=block" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
            
            # Health Check Endpoint
            location /health {
                access_log off;
                return 200 "healthy\n";
                add_header Content-Type text/plain;
            }
            
            # API Routes
            location /api/ {
                limit_req zone=api burst=20 nodelay;
                limit_conn addr 10;
                
                proxy_pass http://trm_backend;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_cache_bypass $http_upgrade;
                proxy_connect_timeout 60s;
                proxy_send_timeout 60s;
                proxy_read_timeout 60s;
            }
            
            # Static Files
            location /static/ {
                alias /app/public/;
                expires 1y;
                add_header Cache-Control "public, immutable";
                access_log off;
            }
            
            # Root
            location / {
                proxy_pass http://trm_backend;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
        }
    }