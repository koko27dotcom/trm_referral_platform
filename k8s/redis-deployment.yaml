apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: trm
  labels:
    app.kubernetes.io/name: redis
    app.kubernetes.io/component: cache
    app.kubernetes.io/part-of: trm-platform
    app.kubernetes.io/instance: redis
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: redis
    app.kubernetes.io/component: cache
  ports:
    - name: redis
      port: 6379
      targetPort: 6379
      protocol: TCP
---
apiVersion: v1
kind: Service
metadata:
  name: redis-headless
  namespace: trm
  labels:
    app.kubernetes.io/name: redis
    app.kubernetes.io/component: cache
    app.kubernetes.io/part-of: trm-platform
    app.kubernetes.io/instance: redis
spec:
  type: ClusterIP
  clusterIP: None
  selector:
    app.kubernetes.io/name: redis
    app.kubernetes.io/component: cache
  ports:
    - name: redis
      port: 6379
      targetPort: 6379
      protocol: TCP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: trm
  labels:
    app.kubernetes.io/name: redis
    app.kubernetes.io/component: cache
    app.kubernetes.io/part-of: trm-platform
    app.kubernetes.io/instance: redis
    version: "7.2"
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app.kubernetes.io/name: redis
      app.kubernetes.io/component: cache
  template:
    metadata:
      labels:
        app.kubernetes.io/name: redis
        app.kubernetes.io/component: cache
        app.kubernetes.io/part-of: trm-platform
        app.kubernetes.io/instance: redis
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9121"
        prometheus.io/path: "/metrics"
        checksum/config: "{{ include (print $.Template.BasePath \"/configmap.yaml\") . | sha256sum }}"
    spec:
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              preference:
                matchExpressions:
                  - key: node-type
                    operator: In
                    values:
                      - cache-optimized
      containers:
        - name: redis
          image: redis:7.2-alpine
          imagePullPolicy: IfNotPresent
          command:
            - redis-server
            - /usr/local/etc/redis/redis.conf
            - --requirepass
            - $(REDIS_PASSWORD)
          ports:
            - name: redis
              containerPort: 6379
              protocol: TCP
          env:
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: trm-app-secrets
                  key: REDIS_PASSWORD
          resources:
            requests:
              cpu: "200m"
              memory: "512Mi"
            limits:
              cpu: "1000m"
              memory: "2Gi"
          livenessProbe:
            exec:
              command:
                - redis-cli
                - -a
                - $(REDIS_PASSWORD)
                - ping
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
            successThreshold: 1
          readinessProbe:
            exec:
              command:
                - redis-cli
                - -a
                - $(REDIS_PASSWORD)
                - ping
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
            successThreshold: 1
          startupProbe:
            exec:
              command:
                - redis-cli
                - -a
                - $(REDIS_PASSWORD)
                - ping
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 30
          volumeMounts:
            - name: redis-data
              mountPath: /data
            - name: redis-config
              mountPath: /usr/local/etc/redis
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            runAsNonRoot: true
            runAsUser: 999
            runAsGroup: 999
          lifecycle:
            preStop:
              exec:
                command:
                  - redis-cli
                  - -a
                  - $(REDIS_PASSWORD)
                  - SAVE
        - name: redis-exporter
          image: oliver006/redis_exporter:v1.54.0-alpine
          imagePullPolicy: IfNotPresent
          args:
            - --redis.addr=redis://localhost:6379
            - --redis.password=$(REDIS_PASSWORD)
            - --web.listen-address=:9121
          env:
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: trm-app-secrets
                  key: REDIS_PASSWORD
          ports:
            - name: metrics
              containerPort: 9121
              protocol: TCP
          resources:
            requests:
              cpu: "50m"
              memory: "64Mi"
            limits:
              cpu: "100m"
              memory: "128Mi"
          livenessProbe:
            httpGet:
              path: /
              port: 9121
            initialDelaySeconds: 30
            periodSeconds: 10
      volumes:
        - name: redis-data
          persistentVolumeClaim:
            claimName: redis-data-pvc
        - name: redis-config
          configMap:
            name: trm-redis-config
            items:
              - key: redis.conf
                path: redis.conf
      terminationGracePeriodSeconds: 60
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: redis-data-pvc
  namespace: trm
  labels:
    app.kubernetes.io/name: redis
    app.kubernetes.io/component: storage
    app.kubernetes.io/part-of: trm-platform
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: fast-ssd
  resources:
    requests:
      storage: 10Gi
---
# Redis High Availability with Sentinel (Optional - for production)
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis-ha
  namespace: trm
  labels:
    app.kubernetes.io/name: redis-ha
    app.kubernetes.io/component: cache-ha
    app.kubernetes.io/part-of: trm-platform
    app.kubernetes.io/instance: redis-ha
spec:
  serviceName: redis-ha-headless
  replicas: 3
  podManagementPolicy: OrderedReady
  updateStrategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app.kubernetes.io/name: redis-ha
      app.kubernetes.io/component: cache-ha
  template:
    metadata:
      labels:
        app.kubernetes.io/name: redis-ha
        app.kubernetes.io/component: cache-ha
        app.kubernetes.io/part-of: trm-platform
        app.kubernetes.io/instance: redis-ha
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - redis-ha
                topologyKey: kubernetes.io/hostname
      initContainers:
        - name: config-init
          image: redis:7.2-alpine
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - |
              REDIS_PASSWORD=$(cat /secrets/redis-password)
              
              # Generate Redis configuration
              cat > /config/redis.conf <<EOF
              port 6379
              dir /data
              appendonly yes
              appendfilename "appendonly.aof"
              appendfsync everysec
              auto-aof-rewrite-percentage 100
              auto-aof-rewrite-min-size 64mb
              save 900 1
              save 300 10
              save 60 10000
              maxmemory 1gb
              maxmemory-policy allkeys-lru
              requirepass $REDIS_PASSWORD
              masterauth $REDIS_PASSWORD
              protected-mode no
              EOF
              
              # Generate Sentinel configuration
              cat > /config/sentinel.conf <<EOF
              port 26379
              dir /tmp
              sentinel monitor trm-master redis-ha-0.redis-ha-headless 6379 2
              sentinel down-after-milliseconds trm-master 5000
              sentinel parallel-syncs trm-master 1
              sentinel failover-timeout trm-master 10000
              sentinel auth-pass trm-master $REDIS_PASSWORD
              EOF
              
              chown 999:999 /config/*.conf
          volumeMounts:
            - name: config
              mountPath: /config
            - name: redis-password
              mountPath: /secrets
              readOnly: true
      containers:
        - name: redis
          image: redis:7.2-alpine
          imagePullPolicy: IfNotPresent
          command:
            - redis-server
            - /config/redis.conf
          ports:
            - name: redis
              containerPort: 6379
              protocol: TCP
          resources:
            requests:
              cpu: "200m"
              memory: "512Mi"
            limits:
              cpu: "1000m"
              memory: "2Gi"
          volumeMounts:
            - name: data
              mountPath: /data
            - name: config
              mountPath: /config
              readOnly: true
          securityContext:
            runAsUser: 999
            runAsGroup: 999
        - name: sentinel
          image: redis:7.2-alpine
          imagePullPolicy: IfNotPresent
          command:
            - redis-sentinel
            - /config/sentinel.conf
          ports:
            - name: sentinel
              containerPort: 26379
              protocol: TCP
          resources:
            requests:
              cpu: "50m"
              memory: "128Mi"
            limits:
              cpu: "200m"
              memory: "256Mi"
          volumeMounts:
            - name: config
              mountPath: /config
              readOnly: true
          securityContext:
            runAsUser: 999
            runAsGroup: 999
      volumes:
        - name: config
          emptyDir: {}
        - name: redis-password
          secret:
            secretName: trm-app-secrets
            items:
              - key: REDIS_PASSWORD
                path: redis-password
  volumeClaimTemplates:
    - metadata:
        name: data
        labels:
          app.kubernetes.io/name: redis-ha
          app.kubernetes.io/component: storage
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: fast-ssd
        resources:
          requests:
            storage: 10Gi
---
apiVersion: v1
kind: Service
metadata:
  name: redis-ha-headless
  namespace: trm
  labels:
    app.kubernetes.io/name: redis-ha
    app.kubernetes.io/component: cache-ha
    app.kubernetes.io/part-of: trm-platform
spec:
  type: ClusterIP
  clusterIP: None
  selector:
    app.kubernetes.io/name: redis-ha
    app.kubernetes.io/component: cache-ha
  ports:
    - name: redis
      port: 6379
      targetPort: 6379
    - name: sentinel
      port: 26379
      targetPort: 26379
---
apiVersion: v1
kind: Service
metadata:
  name: redis-sentinel
  namespace: trm
  labels:
    app.kubernetes.io/name: redis-sentinel
    app.kubernetes.io/component: cache-ha
    app.kubernetes.io/part-of: trm-platform
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: redis-ha
    app.kubernetes.io/component: cache-ha
  ports:
    - name: sentinel
      port: 26379
      targetPort: 26379
---
# PodDisruptionBudget for Redis HA
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: redis-ha-pdb
  namespace: trm
  labels:
    app.kubernetes.io/name: redis-ha
    app.kubernetes.io/component: cache-ha
    app.kubernetes.io/part-of: trm-platform
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: redis-ha
      app.kubernetes.io/component: cache-ha